{% extends 'base.html' %}
{% load static %}

{% block title %}{{ post.title }}{% endblock %}

{% block extra_head %}
  <link rel="stylesheet" href="{% static 'css/main.css' %}">
  <link rel="stylesheet" href="{% static 'css/post_detail.css' %}">
{% endblock %}

{% block content %}
<div class="post-detail-container">

  <!-- 상단: 뒤로가기 + 글쓰기 버튼 -->
  <div class="post-detail-actions">
    <a href="{% url 'post_list' %}" class="btn-back">← 게시판으로</a>
    {% if user.is_authenticated %}
      <a href="{% url 'post_create' %}" class="btn-write">글쓰기</a>
    {% endif %}
  </div>

  <!-- 제목 + 작성자 + 썸네일 -->
  <div class="post-header">
    <div class="title-area">
      <h1 class="post-title">{{ post.title }}</h1>
      <p class="post-meta">
        {{ post.user.nickname }} · {{ post.created_at|date:"Y년 n월 j일 g:i A" }}
      </p>
    </div>

    {% if post.thumbnail %}
      <img src="{{ post.thumbnail.url }}" alt="썸네일" class="post-thumbnail">
    {% endif %}
  </div>

  <!-- 본문 -->
  <div class="post-body">
    <pre class="post-description">{{ post.description }}</pre>
  </div>


  <!-- 좋아요 -->
  {% if user.is_authenticated %}
    <form method="post" action="{% url 'like_post' post.id %}">
      {% csrf_token %}
      <button type="submit" class="btn-like">
        {% if liked %}
          ❤️ 좋아요 취소
        {% else %}
          🤍 좋아요
        {% endif %}
        ({{ post.post_likes.count }})
      </button>
    </form>
  {% endif %}

  <!-- 댓글 섹션 -->
  <div class="comment-section">
    <h3>댓글</h3>

    {% for comment in post.comments.all %}
      {% if not comment.parent %}
        <div class="comment">
          <strong>{{ comment.user.nickname }}</strong>: {{ comment.text }}
          <button class="reply-btn" data-id="{{ comment.id }}">답글</button>

          <!-- 대댓글 목록 -->
          {% for reply in comment.replies.all %}
            <div class="reply">
              ↳ <strong>{{ reply.user.nickname }}</strong>: {{ reply.text }}
            </div>
          {% endfor %}

          <!-- 대댓글 폼 -->
          <form method="post" action="{% url 'comment_reply' comment.id %}" class="reply-form hidden" id="reply-form-{{ comment.id }}">
            {% csrf_token %}
            <input type="text" name="text" placeholder="답글을 입력하세요" required>
            <button type="submit">작성</button>
          </form>
        </div>
      {% endif %}
    {% endfor %}

    <!-- 댓글 작성 -->
    <form method="post" action="" id="commentForm">
      {% csrf_token %}
      {{ comment_form.text }}
      {{ comment_form.parent }}
      <button type="submit">댓글 달기</button>
    </form>
  </div>

</div>
{% endblock %}

{% block extra_script %}
  <script src="{% static 'js/base.js' %}"></script>
  <script src="{% static 'js/post_detail.js' %}"></script>
{% endblock %}
