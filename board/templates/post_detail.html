{% extends 'base.html' %}
{% load static %}
{% load post_tags %}

{% block title %}{{ post.title }}{% endblock %}

{% block extra_head %}
  <link rel="stylesheet" href="{% static 'css/main.css' %}">
  <link rel="stylesheet" href="{% static 'css/post_detail.css' %}">
{% endblock %}

{% block content %}
<div class="post-detail-container">

  <!-- ìƒë‹¨: ë’¤ë¡œê°€ê¸° + ê¸€ì“°ê¸° + ìŠ¤í¬ë© -->
  <div class="post-detail-actions">
    <a href="{% url 'post_list' %}" class="btn-back">â† ê²Œì‹œíŒìœ¼ë¡œ</a>

    <div class="top-buttons">
      <a href="{% url 'post_create' %}" class="btn-write">ê¸€ì“°ê¸°</a>

      <form method="post" action="{% if user.is_authenticated %}{% url 'scrap_post' post.pk %}{% else %}#{% endif %}">
        {% csrf_token %}
        <button type="submit" class="btn-scrap top-scrap {% if not user.is_authenticated %}not-logged-in{% endif %}">
          <img src="{% static 'images/' %}{% if user.is_authenticated and post|scrapped:user %}scrap_on.png{% else %}scrap_off.png{% endif %}" alt="ìŠ¤í¬ë©" class="scrap-icon">
        </button>
      </form>
    </div>
  </div>

  <!-- ì œëª© + ì‘ì„±ì + ì¸ë„¤ì¼ -->
  <div class="post-header">
    <div class="title-area">
      <h1 class="post-title">{{ post.title }}</h1>
      <p class="post-meta">{{ post.user.nickname }} Â· {{ post.created_at|date:"Yë…„ nì›” jì¼ g:i A" }}</p>
    </div>
    {% if post.thumbnail %}
      <img src="{{ post.thumbnail.url }}" alt="ì¸ë„¤ì¼" class="post-thumbnail">
    {% endif %}
  </div>

  <!-- ë³¸ë¬¸ -->
  <div class="post-body">
    <pre class="post-description">{{ post.description }}</pre>
  </div>

  <!-- âœ… ì„ íƒëœ ê³¡ ì •ë³´ -->
  {% if selected_songs %}
  <div class="selected-songs-container">
    <h3>ğŸµ ì„ íƒëœ ê³¡</h3>
    <div class="selected-song-list">
      {% for song in selected_songs %}
      <div class="song-card">
        <a href="{% url 'music_info' %}?title={{ song.title|urlencode }}&artist={{ song.artist|urlencode }}" class="song-info-link">
          {% if song.cover_url %}
          <img src="{{ song.cover_url }}" alt="ì•¨ë²” ì»¤ë²„" class="album-cover">
          {% endif %}
          <div class="song-info">
            <p><strong>{{ song.title }}</strong></p>
            <p>{{ song.artist }}</p>
          </div>
        </a>
        <form method="post" action="{% url 'toggle_lovelist' %}">
          {% csrf_token %}
          <input type="hidden" name="title" value="{{ song.title }}">
          <input type="hidden" name="artist" value="{{ song.artist }}">
          <input type="hidden" name="cover_url" value="{{ song.cover_url }}">
          <button type="submit" class="like-btn">
            {% if song.is_liked %}
              â¤ï¸ ì¢‹ì•„ìš” ì·¨ì†Œ
            {% else %}
              ğŸ¤ ì¢‹ì•„ìš” ì¶”ê°€
            {% endif %}
          </button>
        </form>
      </div>
      {% endfor %}
    </div>
  </div>
  {% else %}
  <p style="margin-top: 20px; color: #ccc;">ì„ íƒëœ ê³¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
  {% endif %}

  <!-- ì¢‹ì•„ìš” + ìˆ˜ì •/ì‚­ì œ -->
  {% if user.is_authenticated or user == post.user %}
    <div class="post-footer-actions-container">
      {% if user.is_authenticated %}
        <form method="post" action="{% url 'like_post' post.id %}">
          {% csrf_token %}
          <button type="submit" class="btn-like">
            {% if liked %}â¤ï¸ ì¶”ì²œ ì·¨ì†Œ{% else %}ğŸ¤ ì¶”ì²œ{% endif %} ({{ post.post_likes.count }})
          </button>
        </form>
      {% endif %}

      {% if user == post.user %}
        <div class="post-actions">
          <form method="get" action="{% url 'post_edit' post.pk %}" style="display:inline;">
            <button type="submit" class="delete-btn">ìˆ˜ì •</button>
          </form>
          <form method="post" action="{% url 'post_delete' post.pk %}" onsubmit="return confirm('ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')" style="display:inline;">
            {% csrf_token %}
            <button type="submit" class="delete-btn">ì‚­ì œ</button>
          </form>
        </div>
      {% endif %}
    </div>
  {% endif %}

  <!-- ëŒ“ê¸€ -->
  <div class="comment-section">
    <h3>ëŒ“ê¸€</h3>

    {% for comment in post.comments.all %}
      {% if not comment.parent %}
        <div class="comment">
          <strong>{{ comment.user.nickname }}</strong>: {{ comment.text }}
          <button class="reply-btn" data-id="{{ comment.id }}">ë‹µê¸€</button>

          {% for reply in comment.replies.all %}
            <div class="reply">â†³ <strong>{{ reply.user.nickname }}</strong>: {{ reply.text }}</div>
          {% endfor %}

          <form method="post" action="{% url 'comment_reply' comment.id %}" class="reply-form hidden" id="reply-form-{{ comment.id }}">
            {% csrf_token %}
            <input type="text" name="text" placeholder="ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" required>
            <button type="submit">ì‘ì„±</button>
          </form>
        </div>
      {% endif %}
    {% endfor %}

    <!-- ëŒ“ê¸€ ì‘ì„± -->
    <form method="post" action="" id="commentForm">
      {% csrf_token %}
      {{ comment_form.text }}
      {{ comment_form.parent }}
      <button type="submit">ëŒ“ê¸€ ë‹¬ê¸°</button>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_script %}
<script src="{% static 'js/base.js' %}"></script>
<script src="{% static 'js/post_detail.js' %}"></script>
{% endblock %}
