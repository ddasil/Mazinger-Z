{% load static %}

<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ê°€ì‚¬ ë° ê³¡ ì •ë³´</title>
  <link rel="stylesheet" href="{% static 'search.css' %}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

</head>
<body>
  <div style="text-align: center; margin: 20px;">
    <div class="input-wrapper" style="display: inline-flex; align-items: center; gap: 8px;">
      <input 
        type="text" 
        id="searchInput" 
        placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”" 
        onkeypress="if(event.key==='Enter'){redirectSearch();}" 
      >
      <button id="micBtn"><i class="fas fa-microphone"></i></button>
      <button id="stopBtn" style="display: none;"><i class="fas fa-stop"></i></button>
      <button onclick="redirectSearch()">ğŸ”</button>
    </div>
  </div>


  <div class="container" style="display: flex; height: 100vh; overflow: hidden;">
    
    <!-- ì™¼ìª½ ê°€ì‚¬ ì˜ì—­ -->
    <div id="infoSection" style="flex: 1; border-right: 1px solid #ccc; padding: 20px; overflow-y: auto;">
      <div style="position: relative; width: 100%; padding-bottom: 56.25%; /* 16:9 ë¹„ìœ¨ */ height: 0;">
        <iframe id="youtubePlayer" 
                style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;" 
                allowfullscreen>
        </iframe>
      </div>
      <!-- ì•¨ë²” ì´ë¯¸ì§€ + ê³¡ ì •ë³´ (ë°˜ì‘í˜•) -->
      <!-- ì•¨ë²” ì •ë³´: ë‚¨ì€ ê³µê°„ì— ê½‰ ì±„ìš°ë˜ ì¤„ì–´ë“¤ ìˆ˜ ìˆìŒ -->
      <div style="display: flex; gap: 20px; flex-grow: 1; overflow: hidden; margin-top: 10px;">
        <div style="flex: 1;">
          <img id="albumCover" src="" alt="ì•¨ë²” ì»¤ë²„"
              style="width: 100%; height: 100%; object-fit: contain; border-radius: 8px;">
        </div>
        <div style="flex: 2; overflow: hidden;">
          <h2>ğŸµ ê³¡ ì •ë³´
            <button id="favoriteBtn">ğŸ¤</button>
          </h2>
          <div id="infoContent">ì •ë³´ ë¡œë”© ì¤‘...</div>
        </div>
      </div>
        
    </div>


    <!-- ì˜¤ë¥¸ìª½ ì •ë³´ ì˜ì—­ -->
    <div id="lyricsSection" style="flex: 1; padding: 20px; overflow-y: auto;">
      <h2>ğŸ“„ ê°€ì‚¬</h2>

            <!-- âœ… ë²ˆì—­ ë²„íŠ¼ë“¤ ì¶”ê°€ -->
      <div class="translation-buttons">
        <button onclick="translateLyrics('ko')">í•œêµ­ì–´</button>
        <button onclick="translateLyrics('en')">ì˜ì–´</button>
        <button onclick="translateLyrics('ja')">ì¼ë³¸ì–´</button>
        <button onclick="translateLyrics('zh')">ì¤‘êµ­ì–´</button>
      </div>

      <div id="lyricsContent">ê°€ì‚¬ ë¡œë”© ì¤‘...</div>
    </div>
  </div>

  <script src="{% static 'lyrics_info.js' %}"></script>
  <script>
    const API_KEY = "{{ youtube_api_key }}";
  </script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const micBtn = document.getElementById('micBtn');
      const stopBtn = document.getElementById('stopBtn');
      const searchInput = document.getElementById('searchInput');
      let recognition = null;
      let isManuallyStopped = false;
    
      if (!micBtn || !stopBtn || !searchInput) return;
    
      micBtn.addEventListener('click', () => {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
          alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
          return;
        }
    
        recognition = new SpeechRecognition();
        recognition.lang = 'ko-KR';
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;
    
        recognition.start();
        micBtn.style.display = "none";
        stopBtn.style.display = "inline";
    
        recognition.onresult = (event) => {
          const transcript = event.results[0][0].transcript;
          searchInput.value = transcript;
          stopMicRecognitionUI();
        };
    
        recognition.onerror = (event) => {
          if (!isManuallyStopped) {
            alert("ìŒì„± ì¸ì‹ ì˜¤ë¥˜: " + event.error);
          }
          stopMicRecognitionUI();
        };
    
        recognition.onend = () => {
          stopMicRecognitionUI();
          isManuallyStopped = false;
        };
      });
    
      stopBtn.addEventListener('click', () => {
        if (recognition) {
          isManuallyStopped = true;
          recognition.stop();
        }
        stopMicRecognitionUI();
      });
    
      function stopMicRecognitionUI() {
        micBtn.style.display = "inline";
        stopBtn.style.display = "none";
      }
    });
    </script>

    <script>
    document.getElementById('favoriteBtn').addEventListener('click', () => {
      const title = document.querySelector('#infoContent h3')?.textContent?.replace('ë…¸ë˜ ì œëª© : ', '');
      const artist = document.querySelector('#infoContent p')?.textContent?.replace('ì•„í‹°ìŠ¤íŠ¸ :', '').trim();
      const albumCover = document.getElementById('albumCover').src;
    
      fetch('/music/toggle-favorite/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ title, artist, albumCover })
      })
      .then(res => res.json())
      .then(data => {
        const btn = document.getElementById('favoriteBtn');
        if (data.status === 'added') btn.textContent = 'â¤ï¸';
        else if (data.status === 'removed') btn.textContent = 'ğŸ¤';
      });
    });
    
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }
    </script>
    
      
    
</body>
</html>
