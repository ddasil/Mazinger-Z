{% extends 'base.html' %}
{% load static %}

{% block title %}Signup{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/main.css' %}">
{% endblock %}

{% block content %}
<div class="signup-container">
  <div class="signup-form">
    <h1>SIGN UP</h1>
    <form method="POST" enctype="multipart/form-data">
      {% csrf_token %}

      <!-- Username -->
      <p>
        {{ form.username.label_tag }}
        {{ form.username }}
        {% if form.username.errors %}
          <span id="username-check" style="font-size: 0.85em; color: red;">
            {{ form.username.errors.0 }}
          </span>
        {% else %}
          <span id="username-check" style="font-size: 0.85em; color: yellow;">
            <!-- JS 중복 확인 메시지가 들어갈 자리 -->
          </span>
        {% endif %}
      </p>
      <ul style="font-size: 0.8em; color: gray; margin-top: -10px; margin-bottom: 10px;">
        <li>영문, 숫자, @/./+/-/_ 가능</li>
        <li>중복 불가, 최대 150자</li>
      </ul>

      <!-- Password -->
      <p>
        {{ form.password1.label_tag }}
        {{ form.password1 }}
        <span id="password-check" style="font-size: 0.85em;"></span>
        {% if form.password1.errors %}
          <div style="font-size: 0.85em; color: red;">{{ form.password1.errors.0 }}</div>
        {% endif %}
      </p>
      <ul style="font-size: 0.8em; color: gray; margin-top: -10px; margin-bottom: 10px;">
        <li>8자 이상</li>
        <li>숫자만 사용 불가</li>
      </ul>

      <p>
        {{ form.password2.label_tag }}
        {{ form.password2 }}
        {% if form.password2.errors %}
          <div style="font-size: 0.85em; color: red;">{{ form.password2.errors.0 }}</div>
        {% endif %}
      </p>

      <!-- Other fields -->
      <p>
        {{ form.birthday.label_tag }}
        {{ form.birthday }}
        {% if form.birthday.errors %}
          <div style="font-size: 0.85em; color: red;">{{ form.birthday.errors.0 }}</div>
        {% endif %}
      </p>

      <p>
        {{ form.phone_number.label_tag }}
        {{ form.phone_number }}
        <small style="font-size: 0.8em; color: gray;">예: 010-1234-5678 형식으로 입력하세요</small>
        {% if form.phone_number.errors %}
          <div style="font-size: 0.85em; color: red;">{{ form.phone_number.errors.0 }}</div>
        {% endif %}
      </p>

      <p>{{ form.profile_picture.label_tag }} {{ form.profile_picture }}</p>

      <button class="btn-glitch" type="submit">SIGN UP</button>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_script %}
<script src="{% static 'js/base.js' %}"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const usernameInput = document.getElementById("id_username");
    const checkMessage = document.getElementById("username-check");
    const passwordInput = document.getElementById("id_password1");
    const passwordCheck = document.getElementById("password-check");
    const phoneInput = document.getElementById("id_phone_number");

    // ✅ 전화번호 자동 하이픈 및 유효성
    function formatPhoneNumber(value) {
      const cleaned = value.replace(/\D/g, "").slice(0, 11);
      if (cleaned.length < 4) return cleaned;
      if (cleaned.length < 8) return `${cleaned.slice(0, 3)}-${cleaned.slice(3)}`;
      return `${cleaned.slice(0, 3)}-${cleaned.slice(3, 7)}-${cleaned.slice(7, 11)}`;
    }

    function validatePhoneNumber(콜) {
      return /^010-\d{4}-\d{4}$/.test(콜);
    }

    if (phoneInput) {
      phoneInput.addEventListener("input", () => {
        phoneInput.value = formatPhoneNumber(phoneInput.value);

        if (validatePhoneNumber(phoneInput.value)) {
          phoneInput.style.border = "2px solid lightgreen";
        } else {
          phoneInput.style.border = "2px solid red";
        }
      });
    }

    // ✅ 아이디 중복 체크
    if (usernameInput) {
      usernameInput.addEventListener("input", function () {
        const username = usernameInput.value.trim();
        if (!username) {
          checkMessage.textContent = "";
          return;
        }

        fetch(`/accounts/check_username/?username=${encodeURIComponent(username)}`)
          .then(res => res.json())
          .then(data => {
            if (data.available) {
              checkMessage.textContent = "사용 가능한 아이디입니다.";
              checkMessage.style.color = "lightgreen";
            } else {
              checkMessage.textContent = "이미 사용 중인 아이디입니다.";
              checkMessage.style.color = "red";
            }
          })
          .catch(err => {
            checkMessage.textContent = "서버 오류";
            checkMessage.style.color = "orange";
          });
      });
    }

    // ✅ 비밀번호 조건 검사 (JS 실시간 피드백)
    if (passwordInput) {
      passwordInput.addEventListener("input", function () {
        const pw = passwordInput.value;
        if (pw.length < 8) {
          passwordCheck.textContent = "비밀번호는 8자 이상이어야 합니다.";
          passwordCheck.style.color = "red";
        } else if (/^\d+$/.test(pw)) {
          passwordCheck.textContent = "숫자만으로는 사용할 수 없습니다.";
          passwordCheck.style.color = "red";
        } else {
          passwordCheck.textContent = "사용 가능한 비밀번호입니다.";
          passwordCheck.style.color = "lightgreen";
        }
      });
    }
  });
</script>
{% endblock %}
