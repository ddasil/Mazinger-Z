{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>AI ê°€ì‚¬ ìƒì„±ê¸°</title>
  <style>
    body {
      background-color: #000;
      padding-top: 140px; /* í—¤ë” ë†’ì´ë§Œí¼ ë³¸ë¬¸ ì•„ë˜ë¡œ ë°€ê¸° */
      padding-bottom: 80px;  /* âœ… í•˜ë‹¨ ì—¬ë°± ì¶”ê°€ */
      margin: 0;
    }

    header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background: black;
      z-index: 1000;
      display: flex;
      align-items: flex-start; /* âœ… ìœ„ë¡œ ì •ë ¬ */
      padding: 10px 20px;
      height: 120px; /* âœ… ë†’ì´ ì¤„ì´ê¸° */
    }

    .logo-box {
      flex: 1;
      display: flex;
      align-items: center;
      height: 60px;
    }

    .logo-box a {
      color: #fff;
      text-decoration: none;
      display: flex;
      align-items: center;
    }

    #logo-image {
      height: 40px;
    }

    #logo-text {
      font-size: 1.8rem;
      margin-left: 10px;
      color: white;
    }

    .header-center {
      position: absolute;
      top: 10px; /* âœ… ë” ìœ„ë¡œ */
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      flex-direction: column;
      align-items: center;
      z-index: 999;
      gap: 10px;
    }

    .fixed-title {
      font-size: 1.8rem;
      color: white;
      margin: 0;
    }

    .header-form {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
    }

    .header-form input,
    .header-form select,
    .header-form button {
      color: white;
      background-color: #222;
      border: 1px solid #555;
      padding: 5px;
    }

    .nav-icon {
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: flex-end;
      margin-left: auto;
      padding-right: 30px;
      height: 60px;
    }

    .nav-icon span {
      display: block;
      height: 4px;
      background: white;
      margin: 5px 0;
      width: 25px;
    }

    .side-menu {
      position: fixed;
      right: -50%;
      top: 0;
      width: 50%;
      height: 100%;
      background: #000;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: right 0.5s ease;
      z-index: 999;
    }

    .wrapper {
      max-width: 1200px;
      margin: 0 auto 80px;
      padding: 0 20px;
    }

    .wrapper.nav-open .side-menu {
      right: 0;
    }

    .side-menu ul {
      list-style: none;
      text-align: right;
      padding: 0;
    }

    .side-menu li {
      font-size: 2rem;
      padding: 20px 0;
      cursor: pointer;
    }

    .side-menu li:hover {
      color: #60a5fa;
    }

    .modal {
      position: fixed;
      top: 10%;
      left: 50%;
      transform: translateX(-50%);
      width: 500px;
      max-height: 80vh;
      overflow-y: auto;
      padding: 20px;
      background: white;
      border: 1px solid #999;
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .modal.show {
      opacity: 1;
    }

    #modalBackdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.4);
      z-index: 999;
      display: none;
    }

    .input-wrapper {
      position: relative;
      display: inline-block;
    }

    .input-wrapper input {
      padding-right: 32px;  /* ë§ˆì´í¬ ì•„ì´ì½˜ ê³µê°„ */
      height: 32px;
      background-color: #222;
      border: 1px solid #555;
      color: white;
    }

    .mic-icon {
      position: absolute;
      top: 50%;
      right: 10px;
      transform: translateY(-50%);
      color: white;
      font-size: 14px;
      cursor: pointer;
      pointer-events: all;
    }

    .mic-btn:hover {
      color: #60a5fa;
    }

  </style>
  <!-- ë§ˆì´í¬ ì•„ì´ì½˜ -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

</head>
<body>

  <!-- âœ… ê³ ì • ìƒë‹¨ë°” -->
  <header>
    <div class="logo-box">
      <a href="#">
        <img id="logo-image" src="{% static 'apple.png' %}">
        <span id="logo-text">MUSICTASTE</span>
      </a>
    </div>

    <div class="header-center">
      <h1 class="fixed-title">AI ë®¤ì¦ˆ</h1>
      <form method="POST" action="{% url 'generate_lyrics' %}" class="header-form">
        {% csrf_token %}
        <div class="input-wrapper">
          <input type="text" name="prompt" id="prompt-input" placeholder="ë…¸ë˜ ì£¼ì œ ì…ë ¥" required>
          <i class="fa-solid fa-microphone mic-icon" id="mic-btn" title="ìŒì„±ì¸ì‹ ì‹œì‘"></i>
          <i class="fa-solid fa-stop mic-icon" id="stop-recognition" style="display: none;" title="ìŒì„±ì¸ì‹ ì¢…ë£Œ"></i> <!-- â¹ ì¤‘ë‹¨ ë²„íŠ¼ -->
        </div>
        
        <select name="style" required>
          <option value="ballad">ë°œë¼ë“œ</option>
          <option value="hip-hop">í™í•©</option>
          <option value="rock">ë¡</option>
          <option value="pop">íŒ</option>
          <option value="indie">ì¸ë””</option>
          <option value="jazz">ì¬ì¦ˆ</option>
        </select>
        <select name="language" required>
          <option value="none">ìƒê´€ì—†ìŒ</option>
          <option value="korean">í•œêµ­ì–´</option>
          <option value="english">English</option>
          <option value="japanese">æ—¥æœ¬èª</option>
          <option value="chinese">ä¸­æ–‡</option>
          <option value="thai">à¹„à¸—à¸¢</option>
        </select>
        <button type="submit">ê°€ì‚¬ ìƒì„±</button>
      </form>
    </div>

    <div class="nav-icon" id="navIcon">
      <span></span>
      <span></span>
      <span></span>
    </div>
  </header>

  <div class="wrapper">
    <!-- âœ… ì‚¬ì´ë“œ ë©”ë‰´ -->
    <nav class="side-menu">
      <ul>
        <li data-target="section1">Home</li>
        <li data-target="section2">Works</li>
        <li data-target="section3">About</li>
        <li data-target="section4">Contact</li>
        <li data-target="section5">Hire us</li>
      </ul>
    </nav>

    {% if lyrics %}
    <hr>
    <div style="display: flex; gap: 40px; align-items: flex-start;">
      <div style="flex: 1;">
        <h2 style="color: white;">ğŸ¤ "{{ title }}"</h2>
        <p style="color: white;"><strong>ì£¼ì œ:</strong> {{ prompt }} / <strong>ìŠ¤íƒ€ì¼:</strong> {{ style }} / <strong>ì–¸ì–´:</strong> {{ language }}</p>
        <pre style="background:#f0f0f0; padding:10px;">{{ lyrics }}</pre>
      </div>
      <div style="flex: 1; text-align: center;">
        <h3 style="color: white;">ğŸ¨ ì•¨ë²” ì´ë¯¸ì§€</h3>
        <img src="{{ new_lyrics.image_file.url }}" width="256" style="border-radius: 8px;"><br>
        <a href="{{ new_lyrics.image_file.url }}" download style="color:white;">ğŸ“¥ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ</a>
        <p style="color: white;">â± ìƒì„± ì‹œê°„: {{ elapsed_time }}ì´ˆ</p>
      </div>
    </div>
    {% endif %}

    {% if all_lyrics %}
    <hr>
    <h2 style="color: white;">ìµœê·¼ì— ë§Œë“  ê°€ì‚¬ë“¤</h2>
    <div style="display: flex; flex-wrap: wrap; gap: 20px;">
      {% for item in all_lyrics %}
      <div onclick="showLyricsModal(`{{ item.prompt }}`, `{{ item.lyrics|escapejs }}`)" style="width: 200px; border: 1px solid #ccc; border-radius: 10px; padding: 10px; background: #fdfdfd; box-shadow: 2px 2px 5px #ddd; cursor: pointer; text-align: center;">
        <img src="{{ item.image_file.url }}" alt="ì•¨ë²” ì´ë¯¸ì§€" style="width: 100%; border-radius: 8px; margin-bottom: 8px;">
        <strong>{{ item.prompt }}</strong><br>
        <small>{{ item.style }} /
        {% if item.language == "korean" %}ğŸ‡°ğŸ‡· í•œêµ­ì–´{% elif item.language == "english" %}ğŸ‡ºğŸ‡¸ ì˜ì–´{% elif item.language == "japanese" %}ğŸ‡¯ğŸ‡µ ì¼ë³¸ì–´{% elif item.language == "chinese" %}ğŸ‡¨ğŸ‡³ ì¤‘êµ­ì–´{% elif item.language == "thai" %}ğŸ‡¹ğŸ‡­ íƒœêµ­ì–´{% else %}ğŸŒ ì–¸ì–´ë¬´ê´€{% endif %}
        </small><br>
        <small>{{ item.created_at|date:"Y-m-d H:i" }}</small>
      </div>
      {% endfor %}
    </div>
    {% endif %}
  </div>

  <div id="lyricsModal" class="modal" style="display:none;">
    <h3 id="modalTitle">ğŸµ ì œëª©</h3>
    <pre id="modalLyrics" style="white-space: pre-wrap; background:#f9f9f9; padding:10px;"></pre>
    <button onclick="closeModal()">ë‹«ê¸°</button>
  </div>
  <div id="modalBackdrop" style="display:none;" onclick="closeModal()"></div>

  <script>
    function showLyricsModal(title, lyrics) {
      const modal = document.getElementById("lyricsModal");
      const backdrop = document.getElementById("modalBackdrop");
      document.getElementById("modalTitle").innerText = `ğŸµ ${title}`;
      document.getElementById("modalLyrics").innerText = lyrics;
      backdrop.style.display = "block";
      modal.style.display = "block";
      setTimeout(() => {
        modal.classList.add("show");
      }, 10);
    }

    function closeModal() {
      const modal = document.getElementById("lyricsModal");
      const backdrop = document.getElementById("modalBackdrop");
      modal.classList.remove("show");
      setTimeout(() => {
        modal.style.display = "none";
        backdrop.style.display = "none";
      }, 300);
    }

    document.addEventListener("keydown", function(e) {
      if (e.key === "Escape") {
        closeModal();
      }
    });

    const navIcon = document.getElementById('navIcon');
    const wrapper = document.querySelector('.wrapper');
    const menuLinks = document.querySelectorAll('.side-menu li');
    navIcon.addEventListener('click', () => {
      wrapper.classList.toggle('nav-open');
    });
    menuLinks.forEach(link => {
      link.addEventListener('click', () => {
        wrapper.classList.remove('nav-open');
      });
    });

    const micBtn = document.getElementById('mic-btn'); 
    const stopBtn = document.getElementById('stop-recognition');
    const promptInput = document.getElementById('prompt-input');

    let recognition = null;
    let isManuallyStopped = false;

    micBtn.addEventListener('click', () => {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        return;
      }

      recognition = new SpeechRecognition();
      recognition.lang = 'ko-KR';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      recognition.start();
      micBtn.style.display = "none";
      stopBtn.style.display = "inline";

      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        promptInput.value = transcript;
        stopMicRecognitionUI();
      };

      recognition.onerror = (event) => {
        if (!isManuallyStopped) {
          alert("ìŒì„± ì¸ì‹ ì˜¤ë¥˜: " + event.error);
        }
        stopMicRecognitionUI();
      };

      recognition.onend = () => {
        stopMicRecognitionUI();
        isManuallyStopped = false;  // ì‚¬ìš©ìê°€ ì¤‘ë‹¨í•œ ê²½ìš° ì´ˆê¸°í™”
      };
    });

    stopBtn.addEventListener('click', () => {
      if (recognition) {
        isManuallyStopped = true;
        recognition.stop();
      }
      stopMicRecognitionUI();
    });

    function stopMicRecognitionUI() {
      micBtn.style.display = "inline";
      stopBtn.style.display = "none";
    }
</script>

</body>
</html>
