{% extends 'base.html' %}
{% load static %}

{% block title %}Mypage{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/main.css' %}">
<link rel="stylesheet" href="{% static 'css/mypage.css' %}">
{% endblock %}

{% block content %}
<div class="mypage-container">


  <!-- í”„ë¡œí•„ ë°•ìŠ¤ -->
  <div class="profile-box">
    {% if user.profile_picture %}
      <img src="{{ user.profile_picture.url }}" alt="Profile Picture" class="profile-picture">
    {% else %}
      <img src="{% static 'images/logo-black.png' %}" alt="Default Picture" class="profile-picture">
    {% endif %}
    <h2>{{ user.username }}</h2>
    <button onclick="openPasswordModal()" class="edit-profile-btn">í”„ë¡œí•„ ìˆ˜ì •</button>
  </div>

  <!-- ì´ë™ ë²„íŠ¼ë“¤ -->
  <div class="link-buttons">
    <a href="{% url 'lyrics' %}" class="mypage-link-btn">ë‚´ê°€ ë§Œë“  ê°€ì‚¬</a>
    <a href="{% url 'music_search' %}" class="mypage-link-btn">ë‚´ í”Œë ˆì´ ë¦¬ìŠ¤íŠ¸</a>
  </div>
</div>

<!-- ğŸ”’ ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ëª¨ë‹¬ -->
<div id="passwordModal" class="modal">
  <div class="modal-content">
    <span class="modal-close" onclick="closePasswordModal()">&times;</span>
    <h3>ë¹„ë°€ë²ˆí˜¸ í™•ì¸</h3>
    <input type="password" id="confirmPassword" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
    <button class="save-btn" onclick="verifyPassword()">í™•ì¸</button>
  </div>
</div>

<!-- âœï¸ í”„ë¡œí•„ ìˆ˜ì • ëª¨ë‹¬ -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <span class="modal-close" onclick="closeModal()">&times;</span>
    <h3>í”„ë¡œí•„ ìˆ˜ì •</h3>
    <form method="POST" enctype="multipart/form-data" class="profile-form">
      {% csrf_token %}
      <label>ID</label>
      <input type="text" value="{{ user.username }}" readonly>

      <label for="id_nickname">ë‹‰ë„¤ì„</label>
      <input type="text" name="nickname" value="{{ user.nickname }}">

      <label for="id_birthday">ìƒì¼</label>
      <input type="date" name="birthday" value="{{ user.birthday|date:'Y-m-d' }}">

      <label for="id_phone_number">ì „í™”ë²ˆí˜¸</label>
      <input type="text" name="phone_number" value="{{ user.phone_number }}">

      <label for="id_profile_picture">í”„ë¡œí•„ ì‚¬ì§„</label>
      <input type="file" name="profile_picture">

      <input type="hidden" name="password" id="hiddenPassword">
      
      <button type="submit" class="save-btn">ì €ì¥</button>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_script %}
<script src="{% static 'js/base.js' %}"></script>
<script>
  function openPasswordModal() {
    document.getElementById("passwordModal").classList.add("show");
  }

  function closePasswordModal() {
    document.getElementById("passwordModal").classList.remove("show");
  }

  function openModal() {
    document.getElementById("editModal").classList.add("show");
  }

  function closeModal() {
    document.getElementById("editModal").classList.remove("show");
  }

  async function verifyPassword() {
    const password = document.getElementById("confirmPassword").value;
    if (password.trim() === "") {
      alert("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
      return;
    }

    try {
      const response = await fetch("{% url 'verify_password' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({ password: password })
      });

      const data = await response.json();
      if (data.success) {
        document.getElementById("hiddenPassword").value = password;
        closePasswordModal();
        openModal();
      } else {
        alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
      }
    } catch (error) {
      console.error("ë¹„ë°€ë²ˆí˜¸ ê²€ì¦ ì˜¤ë¥˜:", error);
      alert("ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
  }
</script>
{% endblock %}
