{% extends 'base.html' %}
{% load static %}

{% block title %}Mypage{% endblock %}

{% block extra_head %}
<!-- 📌 공통 스타일 시트 불러오기 -->
<link rel="stylesheet" href="{% static 'css/main.css' %}">

<!-- 📌 마이페이지 전용 스타일 시트 -->
<link rel="stylesheet" href="{% static 'css/mypage.css' %}">

<!-- ✅ CSRF 토큰을 JS에서 사용하기 위해 메타 태그로 삽입 -->
<meta name="csrf-token" content="{{ csrf_token }}">
{% endblock %}


{% block content %}
<!-- 🔵 마이페이지 상단 프로필 영역 -->
<div class="mypage-container">
  <div class="profile-box">
    <!-- ✅ 현재 설정된 프로필 이미지 표시 (없으면 기본 이미지) -->
    {% if form.profile_picture.value %}
      <img src="{% static 'images/profiles/'|add:form.profile_picture.value %}" alt="Profile Picture" class="profile-picture">
    {% else %}
      <img src="{% static 'images/logo-black.png' %}" alt="Default Picture" class="profile-picture">
    {% endif %}
    <h2>{{ form.username.value }}</h2>
    <p class="nickname-display">{{ form.nickname.value }}</p>
    <button id="openPasswordBtn" class="edit-profile-btn">프로필 수정</button>
  </div>

  <!-- 🔗 내가 만든 가사 / 플레이리스트 바로가기 -->
  <div class="link-buttons">
    <a href="{% url 'lyrics_root' %}" class="mypage-link-btn">내가 만든 가사</a>
    <a href="/music/" class="mypage-link-btn">내 플레이 리스트</a>
  </div>
</div>

<!-- 🔐 비밀번호 확인 모달 -->
<div id="passwordModal" class="modal">
  <div class="modal-content">
    <span class="modal-close" onclick="closePasswordModal()">&times;</span>
    <h3>비밀번호 확인</h3>
    <input type="password" id="confirmPassword" placeholder="비밀번호를 입력하세요">
    <button class="save-btn" onclick="verifyPassword()">확인</button>
  </div>
</div>

<!-- ✏️ 프로필 수정 모달 -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <span class="modal-close" onclick="closeModal()">&times;</span>
    <h3>프로필 수정</h3>

    <!-- 🔐 수정 폼 시작 -->
    <form method="POST" class="profile-form">
      {% csrf_token %}

      <!-- ✅ 아이디(읽기 전용) -->
      <label>ID</label>
      <input type="text" name="username" id="id_username" value="{{ form.username.value }}" readonly>

      <!-- ✅ 닉네임 입력 -->
      <label for="id_nickname">닉네임</label>
      <input type="text" name="nickname" id="id_nickname"
            value="{{ form.nickname.value|default_if_none:'' }}"
            placeholder="닉네임 입력">
      {% if form.nickname.errors %}
        <div class="nickname-error error" style="color:red">{{ form.nickname.errors.0 }}</div>
      {% endif %}

      <!-- ✅ 생일 입력 -->
      <label for="id_birthday">생일</label>
      <input type="date" name="birthday" id="id_birthday"
             value="{{ form.birthday.value|date:'Y-m-d' }}">

      <!-- ✅ 전화번호 입력 -->
      <label for="id_phone_number">전화번호</label>
      <input type="text" name="phone_number" id="id_phone_number"
             value="{{ form.phone_number.value|default_if_none:'' }}" placeholder="010-1234-5678">

      <!-- ✅ 프로필 이미지 선택 -->
      <label for="id_profile_picture">프로필 사진 선택</label>
      <select name="profile_picture" id="id_profile_picture" class="form-control">
        {% for val, label in form.fields.profile_picture.choices %}
          <option value="{{ val }}" {% if form.profile_picture.value == val %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>

      <!-- ✅ 실시간 미리보기 영역 -->
      <div class="preview-box">
        <img id="profilePreview" src="{% static 'images/profiles/' %}{{ form.profile_picture.value }}" class="profile-preview" alt="선택된 프로필 미리보기">
      </div>

      <!-- ✅ 비밀번호 hidden 처리 (수정 시 검증용) -->
      <input type="hidden" name="password" id="hiddenPassword">

      <!-- ✅ 수정 버튼 (조건 충족해야 활성화됨) -->
      <button type="submit" id="submit-btn" disabled class="btn btn-primary">수정</button>
    </form>
  </div>
</div>
{% endblock %}


{% block extra_script %}
<script src="{% static 'js/base.js' %}"></script>
<script src="{% static 'js/mypage.js' %}"></script>

{% endblock %}
