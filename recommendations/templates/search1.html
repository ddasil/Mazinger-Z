{% extends 'base.html' %}
{% load static %}

{% block title %}노래 추천 검색{% endblock %}

{% block content %}
<div class="container"
    style="height: 100vh; display: flex; justify-content: center; align-items: center; flex-direction: column;">
    <h1 style="color: white; font-size: 2.5rem; margin-bottom: 30px; font-family: 'Raleway', sans-serif;">
        <i class="fa-solid fa-music" style="color: #9b59b6; margin-right: 10px;"></i>
        추천 시스템(책, 여행지)
    </h1>
    <form method="get" action="/recommend/" style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
        <div style="position: relative; display: flex; align-items: center;">
            <input type="text" name="q" id="prompt-input" placeholder="ex) 노래제목 - 가수" required
                style="padding: 10px 40px 10px 10px; border-radius: 6px; border: none; background-color: #222; color: white; width: 350px; height: 44px;">
            <button type="button" id="mic-btn" title="음성인식 시작"
                style="position: absolute; right: 10px; background-color: transparent; border: none; cursor: pointer; height: 44px; display: flex; align-items: center;">
                <i class="fa-solid fa-microphone" style="color: #555; font-size: 20px;"></i>
            </button>
        </div>
        <select name="count"
            style="background-color: #333; color: white; border: none; padding: 0 10px; border-radius: 6px; height: 44px;">
            <option value="1">1개</option>
            <option value="2">2개</option>
            <option value="3" selected>3개</option>
            <option value="4">4개</option>
            <option value="5">5개</option>
        </select>
        <button type="submit"
            style="background-color: #9b59b6; color: white; border: none; padding: 0 16px; border-radius: 6px; height: 44px; transition: background-color 0.3s ease;"
            onmouseover="this.style.backgroundColor='#823c99';" onmouseout="this.style.backgroundColor='#9b59b6';">
            검색
        </button>
    </form>
</div>
{% endblock %}

{% block extra_script %}
<script>
    const navIcon = document.getElementById('navIcon');
    const wrapper = document.querySelector('.wrapper');
    const menuLinks = document.querySelectorAll('.side-menu li');

    navIcon.addEventListener('click', () => {
        wrapper.classList.toggle('nav-open');
    });

    menuLinks.forEach(link => {
        link.addEventListener('click', () => {
            const targetId = link.getAttribute('data-target');
            document.getElementById(targetId).scrollIntoView({ behavior: 'smooth' });
            wrapper.classList.remove('nav-open');
        });
    });

    document.addEventListener('click', (event) => {
        const isMenuOpen = wrapper.classList.contains('nav-open');
        const isNavIcon = event.target.closest('#navIcon');
        const isSideMenu = event.target.closest('.side-menu');
        if (isMenuOpen && !isNavIcon && !isSideMenu) {
            wrapper.classList.remove('nav-open');
        }
    });



    document.addEventListener("DOMContentLoaded", () => {
        const modal = document.getElementById("modal");
        const closeModalBtn = document.getElementById("closeModalBtn");
        const contactForm = document.getElementById("contactForm");
        const openModalBtn = document.getElementById("openModalBtn");
        const homeButton = document.querySelector('#contactForm button[type="submit"]');

        closeModalBtn.addEventListener("click", () => {
            modal.style.display = "none";
        });

        openModalBtn.addEventListener("click", () => {
            modal.style.display = "flex";
        });

        homeButton.addEventListener("click", (event) => {
            event.preventDefault();
            window.location.reload(); // ✅ 그냥 새로고침
        });

        contactForm.reset();
    });


    document.addEventListener("DOMContentLoaded", () => {
        const $filter = document.querySelector('.svg-sprite');
        const $turb = $filter.querySelector('#filter feTurbulence');
        const turbVal = { val: 0.000001 };
        const turbValX = { val: 0.000001 };

        const glitchTimeline = () => {
            const timeline = gsap.timeline({
                repeat: -1,
                repeatDelay: 2,
                paused: true,
                onUpdate: () => {
                    $turb.setAttribute('baseFrequency', turbVal.val + ' ' + turbValX.val);
                }
            });

            timeline
                .to(turbValX, { val: 0.5, duration: 0.1 })
                .to(turbVal, { val: 0.02, duration: 0.1 })
                .set(turbValX, { val: 0.000001 })
                .set(turbVal, { val: 0.000001 })
                .to(turbValX, { val: 0.4, duration: 0.2 }, 0.4)
                .to(turbVal, { val: 0.002, duration: 0.2 }, 0.4)
                .set(turbValX, { val: 0.000001 })
                .set(turbVal, { val: 0.000001 });

            return {
                start: () => timeline.play(0),
                stop: () => timeline.pause()
            };
        };

        const btnGlitch = glitchTimeline();

        document.querySelectorAll('.btn-glitch').forEach(button => {
            button.addEventListener('mouseenter', () => {
                button.classList.add('btn-glitch-active');
                btnGlitch.start();
            });
            button.addEventListener('mouseleave', () => {
                button.classList.remove('btn-glitch-active');
                btnGlitch.stop();
            });
        });
        window.addEventListener('pageshow', function (event) {
            if (event.persisted) {
                window.location.reload();
            }
        });
    });




    // 음성 인식
    const micBtn = document.getElementById('mic-btn');
    const micIcon = micBtn.querySelector('i');
    const promptInput = document.getElementById('prompt-input');
    let recognition = null;
    let isRecording = false;

    micBtn.addEventListener('click', () => {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            alert("이 브라우저는 음성 인식을 지원하지 않습니다.");
            return;
        }

        if (!isRecording) {
            // 시작
            recognition = new SpeechRecognition();
            recognition.lang = 'ko-KR';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            recognition.start();
            isRecording = true;
            micIcon.classList.remove('fa-microphone');
            micIcon.classList.add('fa-stop');

            recognition.onresult = (event) => {
                promptInput.value = event.results[0][0].transcript;
            };

            recognition.onerror = (event) => {
                alert("음성 인식 오류: " + event.error);
            };

            recognition.onend = () => {
                isRecording = false;
                micIcon.classList.remove('fa-stop');
                micIcon.classList.add('fa-microphone');
            };
        } else {
            // 중지
            recognition.stop();
            isRecording = false;
            micIcon.classList.remove('fa-stop');
            micIcon.classList.add('fa-microphone');
        }
    });
</script>
{% endblock %}